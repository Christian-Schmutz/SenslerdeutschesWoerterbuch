# containerapp-deploy.yaml
location: Switzerland North # Or your app's region
properties:
  # Reference your existing Container App Environment
  managedEnvironmentId: /subscriptions/9f833d03-bba1-48f9-8087-b5ba39f8b62f/resourceGroups/senslerdeutsches-woerterbuch/providers/Microsoft.App/managedEnvironments/managedEnvironment-senslerdeutsche-b6f7

  configuration:
    secrets:
      # --- Define Secrets for Sensitive Data ---
      - name: elastic-admin-password
      # Add other secrets as needed
    # --- ACR Credentials (Managed Identity Preferred) ---
    # If using Managed Identity + AcrPull role, you can omit 'registries'.
    # If using credentials, define them (ensure secrets exist in ACA):
    # registries:
    #   - server: youracrname.azurecr.io
    #     username: your_registry_user_or_sp_id
    #     passwordSecretRef: registry-password # Name of secret in Container App

    # --- Ingress: Pointing to Proxy (Publicly Available) ---
    ingress:
      external: true       # Allow public internet traffic
      targetPort: 80       # The port your PROXY container listens on
      # Optional: Use your configured custom domain
      # customDomains:
      #  - name: your.customdomain.com
      #    bindingType: SniEnabled
      #    certificateId: /subscriptions/YOUR_SUBSCRIPTION_ID/resourceGroups/YOUR_RESOURCE_GROUP/providers/Microsoft.App/managedEnvironments/YOUR_ACA_ENVIRONMENT_NAME/certificates/your-certificate-name # If using managed certs
      transport: auto      # Or http/http2/tcp
      # Optional: IP security restrictions if needed

  template:
    # --- Define the Containers for the New Revision ---
    containers:
      # 1. Proxy Container (Public Ingress Target)
      - name: proxy
        image: seislerwoerterbuech.azurecr.io/proxy:latest # Or specific tag/sha
        resources:
          cpu: 0.5
          memory: 1Gi
        env:
          - name: ELASTICSEARCH_URL # Internal URL for ES
            value: http://localhost:9200
        # Add probes if needed

      # 2. Backend Container (Internal Only)
      - name: backend
        image: seislerwoerterbuech.azurecr.io/backend:latest # Or specific tag/sha
        resources:
          cpu: 0.5
          memory: 1Gi
        env:
          - name: ELASTIC_URL
            value: http://localhost:9200
          - name: ELASTIC_ADMIN_USERNAME
            value: elastic
          - name: ELASTIC_ADMIN_PASSWORD
            secretRef: elastic-admin-password     
          - name: ELASTIC_INDEX
            value: dictionary     
          - name: ELASTIC_READER_USERNAME
            value: dictionary_reader
          - name: ELASTIC_READER_PASSWORD
            value: thisisgonnabepublic     

          # Add other necessary env vars/secrets
        # NO Ingress block for this container = Internal only

      # 3. Elasticsearch Container (Internal Only)
      - name: elasticsearch
        image: docker.elastic.co/elasticsearch/elasticsearch:8.17.3 # Use a specific version
        resources:
          cpu: 1.0
          memory: 2Gi
        env:
          - name: ELASTIC_PASSWORD
            secretRef: elastic-admin-password
          - name: xpack.security.enabled
            value: true
          - name: xpack.security.http.ssl.enabled
            value: false
          - name: xpack.security.transport.ssl.enabled
            value: false
          - name: discovery.type
            value: single-node # Required to disable SSL while keeping security enabled
        # NO Ingress block for this container = Internal only
        # Consider adding volume mounts for persistence if needed

    # --- Optional: Scale settings ---
    # scale:
    #   minReplicas: 1
    #   maxReplicas: 3